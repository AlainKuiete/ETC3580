---
title: 'Week 2: Solutions'
author: "ETC3580"
output:
  html_document:
    fig_height: 5
    fig_width: 8
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    code_folding: show
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, warning=FALSE, message=FALSE)
options(width=80,digits=3)
```

```{r loadpackages}
library(tidyverse)
library(visreg)
library(broom)
```

# Exercise 2A

## A1

```{r A1}
fit2 <- lm(Fertility ~ (.)^2, data=swiss) %>% step(trace=FALSE)
summary(fit2)
aug <- augment(fit2)
ggplot(aug, aes(x=.fitted, y=.resid)) +
  geom_point() + geom_smooth()
```

## A2

```{r A2}
ggplot(aug, aes(x=Agriculture, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=Examination, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=Education, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=Catholic, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=Infant.Mortality, y=.resid)) +
  geom_point() + geom_smooth()
```

There is some evidence of nonlinearity with Education, but there is not a lot of data for Education level above 18%.

None of the other residual plots reveal nonlinearities or heteroscedasticity.

## A3

```{r A3}
ggplot(aug, aes(sample=.resid)) +
  geom_qq()
```

These look close to normally distributed.

## A4

```{r A4}
ggplot(aug, aes(x=.hat)) +
  geom_dotplot()
```


## A5

```{r A5}
ggplot(aug, aes(x=.cooksd)) +
  geom_dotplot()
ggplot(aug, aes(x=.cooksd, y=.hat)) +
  geom_point()
```

There is one observation having a large effect on the fitted model.

```{r A5b}
aug %>% filter(.cooksd > 0.6) %>% glimpse()
```

This canton contains Geneva and has the lowest Fertility, the lowest Agriculture, the highest Education and the highest Examination values.

# Exercise 2B

```{r Bgss}
load("gss.RData")
gss %>%
  # Select variables we want to use
  select(prestige, year, age, sex, race, degree, class) %>%
  # Convert prestige and age to numeric variables
  # and recode degree and class to fix missing values
  mutate(
    prestige = as.numeric(substr(prestige,1,2)),
    age = as.numeric(substr(age, 1, 2)),
    degree = recode(degree,
                "JUNIOR COLLEGE" = "HIGH SCHOOL",
                "DK" = NA_character_,
                "NA" = NA_character_),
   class = recode(class,
                "IAP" = NA_character_,
                "NO CLASS" = NA_character_,
                "DK" = NA_character_,
                "NA" = NA_character_)) ->
    mydata

fit4 <- lm(prestige ~ (year + age + sex + race + degree + class)^2,
           data=mydata) %>%
        step(trace=FALSE)
```

## B1

```{r B1}
aug <- augment(fit4)
ggplot(aug, aes(x=.fitted, y=.resid)) +
  geom_point() + geom_smooth()
```

While the residuals show no signs of bias or heteroscedasticity, there is a visible pattern due to the values that `prestige` takes. Because `prestige` takes integer values between 12 and 82, the residuals appear as diagonal lines on the plot (with 12 at the bottom left and 82 at the top right).

## B2

```{r B2}
ggplot(aug, aes(x=year, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=age, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=sex, y=.resid)) +
  geom_boxplot() + geom_smooth()
ggplot(aug, aes(x=race, y=.resid)) +
  geom_boxplot() + geom_smooth()
ggplot(aug, aes(x=degree, y=.resid)) +
  geom_boxplot() + geom_smooth()
ggplot(aug, aes(x=class, y=.resid)) +
  geom_boxplot() + geom_smooth()
```

None of these residual plots reveal nonlinearities or heteroscedasticity.

## B3

```{r B3}
ggplot(aug, aes(x=.hat)) +
  geom_dotplot()
```


## B4

```{r B4}
ggplot(aug, aes(x=.cooksd)) +
  geom_dotplot()
ggplot(aug, aes(x=.cooksd, y=.hat)) +
  geom_point()
```

No observation appears particularly influential.


# Exercise 2C

## C1

```{r C1}
teengamb <- as_tibble(faraway::teengamb) %>%
  mutate(sex=factor(sex, levels=c(0,1), labels=c("male","female")))
teengamb
```

## C2

```{r C2}
fit <- lm(gamble ~ (sex + status + income + verbal)^2, data=teengamb) %>%
  step(trace=FALSE)
summary(fit)
```

## C3

```{r C3}
visreg(fit, "income", by="sex", gg=TRUE) + theme_bw()
visreg2d(fit, "income", "status")
```

  * For males, the expenditure on gambling increases as income goes up, but there is no relationship between gambling and income for females. (Smart girls!)
  * Gambling is greatest for high income / low status individuals. (Perhaps they never learned how to manage disposable income.)

## C4

```{r C4}
aug <- augment(fit)
ggplot(aug, aes(x=.fitted, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=sex, y=.resid)) +
  geom_boxplot()
ggplot(aug, aes(x=income, y=.resid)) +
  geom_point() + geom_smooth()
ggplot(aug, aes(x=status, y=.resid)) +
  geom_point() + geom_smooth()
```

There is some heteroscedasticity between males and females, but no other obvious problems with the model.

```{r C4b}
ggplot(aug, aes(x=.cooksd, y=.hat)) +
  geom_point()
```

There are three obsevations having a relatively big impact on the final model.

```{r C4c}
aug %>%
  filter(.hat > 0.4 | .cooksd > 0.2) %>%
  glimpse()
```

These are 3 of the highest spending males with the highest incomes.
